# UniLab ‚Äì Laborat√≥rio de Ciberseguran√ßa (API REST + Frontend)# UniLab ‚Äì Laborat√≥rio de Ciberseguran√ßa (Express + MySQL + Sequelize)



Este projeto simula um portal de uma universidade, intencionalmente vulner√°vel, para fins educacionais e de laborat√≥rio (CTF).Este projeto simula um portal de uma universidade, intencionalmente vulner√°vel, para fins educacionais e de laborat√≥rio.



## üéØ Vulnerabilidades Inclu√≠dasInclui exemplos das seguintes vulnerabilidades:

- XSS (refletido e armazenado)

- **XSS** (Refletido e Armazenado)- IDOR (Insecure Direct Object Reference)

- **IDOR** (Insecure Direct Object Reference)- BOLA (Broken Object Level Authorization)

- **BOLA** (Broken Object Level Authorization)- SQL Injection (SQLi) - **Agora usando Sequelize com queries seguras**

- **Mass Assignment** (atribui√ß√£o massiva)- RCE (Remote Code Execution)

- **SSRF** (Server-Side Request Forgery)- Race Condition (condi√ß√£o de corrida)

- **JWT Inseguro** (decodifica√ß√£o client-side sem valida√ß√£o)- Mass Assignment (atribui√ß√£o massiva)

- **OTP no Cookie** (c√≥digo de recupera√ß√£o exposto)- SSRF (Server-Side Request Forgery)

- **Senha em texto plano** (sem hash)

- **Race Condition** (condi√ß√£o de corrida)**‚ö†Ô∏è IMPORTANTE**: Este projeto foi migrado de queries SQL raw para **Sequelize ORM**, eliminando as vulnerabilidades de SQL Injection. Agora possui tamb√©m um **sistema robusto de tratamento de erros**.



**‚ö†Ô∏è AVISO**: N√£o utilize este c√≥digo em produ√ß√£o. Execute em ambiente isolado.Aviso: N√£o utilize este c√≥digo em produ√ß√£o. Execute em ambiente isolado.



## üèóÔ∏è Arquitetura## Arquitetura

- Node.js/Express com EJS (servidor e views)

### Backend (API REST)- MySQL 8 (com dados de exemplo)

- Node.js/Express- **Sequelize ORM** para acesso seguro ao banco de dados

- Respostas em JSON- **Sistema de tratamento de erros global**

- Sequelize ORM (MySQL)- Adminer para inspe√ß√£o do banco

- JWT para autentica√ß√£o- Orquestra√ß√£o com Docker Compose

- CORS habilitado

## Subida r√°pida (Docker)

### Frontend (SPA-like)1. Copie o `.env.example` para `.env` caso queira alterar algo (opcional).

- HTML5/CSS3/JavaScript puro2. Suba os servi√ßos:

- Fetch API para comunica√ß√£o com backend

- Gest√£o de autentica√ß√£o via cookies```powershell

- Interface moderna e responsiva# No diret√≥rio university-lab

docker compose up -d --build

### Infraestrutura```

- MySQL 8 (dados de exemplo)

- Adminer (interface web para DB)3. Acesse:

- Docker Compose (orquestra√ß√£o)- App: http://localhost:3000

- Adminer: http://localhost:8080 (Servidor: db, Usu√°rio: unilab, Senha: unilabpwd, DB: unilab)

## üöÄ Como Executar

Credenciais de teste (login vulner√°vel por SQLi, mas tamb√©m funcionam normalmente):

### Com Docker (Recomendado)- admin@uni.local / admin

- eve@uni.local / eve

```bash- mallory@uni.local / mallory

# Suba os servi√ßos

docker compose up -d --build## Onde encontrar cada vulnerabilidade

- XSS

# Acessar  - Armazenado: p√°gina inicial (‚ÄúAn√∫ncios‚Äù) renderiza HTML de `announcements.body` sem sanitiza√ß√£o.

# App: http://localhost:3000  - Refletido: `/students?q=` reflete o par√¢metro sem escapar.

# API: http://localhost:3000/api  - Coment√°rios em `/students/:id` s√£o armazenados e renderizados sem escapar.

# Adminer: http://localhost:8080- IDOR

```  - `/students/:id` retorna qualquer perfil sem verifica√ß√£o se pertence ao usu√°rio logado.

- BOLA

### Sem Docker  - `/admin/grades/:id` retorna a nota por ID mesmo se n√£o pertencer ao usu√°rio.

- SQLi

```bash  - `/login` concatena `email` e `password` na query.

# Instalar depend√™ncias  - `/students?q=` usa `LIKE` concatenado.

npm install- RCE

  - `/admin/exec?cmd=` executa o comando arbitr√°rio e retorna a sa√≠da.

# Configurar vari√°veis de ambiente (opcional)- Race condition

export DB_HOST=localhost  - `/courses/:id/enroll` faz leitura e decremento de vagas sem transa√ß√£o/lock.

export DB_USER=unilab- Mass assignment

export DB_PASSWORD=unilabpwd  - `POST /students/:id/update` aplica `req.body` como SET sem whitelist.

export DB_NAME=unilab- SSRF

export PORT=3000  - `/utils/fetch?url=` busca qualquer URL do lado do servidor e retorna o conte√∫do.



# Executar scripts SQL em db/init/ no MySQL## Fluxos de demonstra√ß√£o (exemplos)

- Login: http://localhost:3000/login

# Iniciar servidor  - Teste SQLi: use `email: ' OR '1'='1` e qualquer senha.

npm start- Estudantes: http://localhost:3000/students

  - Pesquise com `<img src=x onerror=alert('xss')>` para XSS refletido.

# Ou modo desenvolvimento- Perfil do estudante: http://localhost:3000/students/1

npm run dev  - Poste coment√°rio com HTML/script para XSS armazenado.

```- Cursos: http://localhost:3000/courses

  - Dispare m√∫ltiplos `Matricular` em paralelo para ver a condi√ß√£o de corrida.

## üë• Credenciais de Teste- Notas (BOLA): http://localhost:3000/admin/grades/1

- Execu√ß√£o remota: http://localhost:3000/admin/exec?cmd=whoami

- **Admin**: admin@uni.local / admin- SSRF: http://localhost:3000/utils/fetch?url=http://example.com

- **Usu√°rio 1**: eve@uni.local / eve

- **Usu√°rio 2**: mallory@uni.local / mallory## Estrutura

- `src/server.js` ‚Äì servidor Express e rotas com middleware de erros

## üìç Endpoints da API- `src/routes/*` ‚Äì endpoints vulner√°veis

- `src/models/*` ‚Äì **Modelos Sequelize (User, Student, Course, etc.)**

### Autentica√ß√£o (`/api/auth`)- `src/utils/db.js` ‚Äì **conex√£o Sequelize (substituiu mysql2 raw)**

- `POST /api/auth/register` - Criar conta- `src/utils/asyncHandler.js` ‚Äì **Helpers para tratamento de erros**

- `POST /api/auth/login` - Login- `src/views/*` ‚Äì EJS (renderiza√ß√£o insegura em alguns pontos)

- `POST /api/auth/logout` - Logout- `db/init/*.sql` ‚Äì schema e dados de exemplo (carregados automaticamente pelo MySQL do Docker)

- `POST /api/auth/forgot-password` - Solicitar c√≥digo OTP- `docker-compose.yml` ‚Äì orquestra√ß√£o app+db+adminer

- `POST /api/auth/reset-password` - Redefinir senha- `Dockerfile` ‚Äì build da aplica√ß√£o Node

- `GET /api/auth/get-otp` - üö® Obter OTP (vulnerabilidade)- `docs/ERROR_HANDLING.md` ‚Äì **Documenta√ß√£o do sistema de tratamento de erros**

- `GET /api/auth/my-otp` - üö® Ver pr√≥prio OTP (vulnerabilidade)

- `GET /api/auth/list-otps` - üö® Listar OTPs (vulnerabilidade)## Tema visual (Design System)

O site foi atualizado com uma interface moderna e limpa baseada na paleta:

### Usu√°rios (`/api/users`)

- `GET /api/users` - Listar usu√°rios (suporta `?q=busca`)- Indigo profundo: `#151340`

- `GET /api/users/:id` - Ver perfil- Azul marinho: `#232440`

- `POST /api/users/:id/comments` - Adicionar coment√°rio- Menta 1: `#73D99F`

- `PUT /api/users/:id` - Atualizar perfil- Menta 2: `#79F297`

- `DELETE /api/users/:id` - Excluir usu√°rio (admin)- Creme: `#F2E8DF`

- `DELETE /api/users/:id/comments/:commentId` - Excluir coment√°rio

Tokens dispon√≠veis em `public/styles.css` (via CSS variables em `:root`):

### Utilit√°rios (`/api/utils`)

- `GET /api/utils/fetch?url=` - üö® SSRF: buscar URL- Cores sem√¢nticas: `--bg`, `--surface`, `--text`, `--text-muted`, `--primary`, `--brand`, `--border`

- `GET /api/utils/jwt/mint` - üö® Criar JWT customizado- Espa√ßamento/est√©tica: `--radius`, `--radius-sm`, `--radius-lg`, `--shadow`, `--focus`



### Health CheckComponentes e utilit√°rios inclu√≠dos:

- `GET /api/health` - Status da API

- Bot√µes (`.button`, `.btn`, varia√ß√µes `.secondary`)

## üïµÔ∏è Onde Encontrar Vulnerabilidades- Inputs e formul√°rios (foco com realce na cor prim√°ria)

- Cards (`.card`, `.card-body`)

### XSS Refletido- Tabelas com cabe√ßalho escuro e listras alternadas

```- Layouts (`.container`, `.container-narrow`, `.row`, `.stack`)

GET /users.html?q=<script>alert('XSS')</script>

```Tipografia utiliza a fonte ‚ÄúInter‚Äù via Google Fonts adicionada em `src/views/layout.ejs`.

O par√¢metro `q` √© refletido na p√°gina sem sanitiza√ß√£o.

## Observa√ß√µes did√°ticas

### XSS Armazenado- Cookies n√£o s√£o assinados, n√£o usam HttpOnly; auth √© fr√°gil e simplista.

1. Acesse `/user.html?id=1`- ~~Queries concatenadas foram usadas de prop√≥sito para SQLi.~~ **ATUALIZADO**: Agora usa Sequelize ORM com queries parametrizadas (seguras).

2. Adicione coment√°rio com payload: `<img src=x onerror=alert('XSS')>`- Renderiza√ß√µes com `<%- %>` permitem XSS.

3. O coment√°rio ser√° renderizado sem escape- Endpoints ignoram checagem de autoriza√ß√£o/ownership (IDOR/BOLA).

- SSRF n√£o valida destino.

### IDOR- Race condition causada por opera√ß√µes sem transa√ß√£o/lock.

```- Mass assignment atualiza colunas arbitr√°rias com dados do cliente.

GET /api/users/1- **Sistema de tratamento de erros**: Middleware global captura exce√ß√µes n√£o tratadas e previne crash da aplica√ß√£o.

GET /api/users/2

```## Melhorias Implementadas

Qualquer usu√°rio pode acessar perfis de outros sem autoriza√ß√£o.

### 1. Migra√ß√£o para Sequelize ORM

### Mass Assignment- ‚úÖ Todas as queries SQL raw foram substitu√≠das por m√©todos do Sequelize

```- ‚úÖ Queries parametrizadas previnem SQL Injection

PUT /api/users/:id- ‚úÖ Modelos organizados em `src/models/`

Body: { "role": "admin", "password": "hacked" }- ‚úÖ Relacionamentos entre entidades definidos corretamente

```

Atualiza campos sens√≠veis sem whitelist.### 2. Sistema de Tratamento de Erros

- ‚úÖ Middleware global de erros em `src/server.js`

### OTP no Cookie- ‚úÖ Handler para rotas 404

1. Solicite reset de senha em `/forgot-password.html`- ‚úÖ Captura de erros ass√≠ncronos n√£o tratados

2. Abra Console do navegador (F12)- ‚úÖ Shutdown gracioso (fecha conex√µes do DB)

3. Digite: `document.cookie`- ‚úÖ Helpers `asyncHandler` e `createError` em `src/utils/asyncHandler.js`

4. O OTP est√° vis√≠vel no cookie `reset_otp`- ‚úÖ Logs detalhados de erros com stack trace

- ‚úÖ Respostas diferenciadas para JSON e HTML

### SSRF- üìñ Documenta√ß√£o completa em `docs/ERROR_HANDLING.md`

```

GET /api/utils/fetch?url=http://169.254.169.254/latest/meta-data/Aproveite com responsabilidade e em ambiente isolado.

GET /api/utils/fetch?url=http://localhost:3000/api/auth/list-otps
```

### JWT Inseguro
O JWT √© decodificado no client-side sem valida√ß√£o de assinatura:
```javascript
// No console do navegador
const token = document.cookie.split('token=')[1].split(';')[0];
const payload = JSON.parse(atob(token.split('.')[1]));
console.log(payload); // { id, name, role }
```

## üìÅ Estrutura do Projeto

```
.
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îî‚îÄ‚îÄ init/              # Scripts SQL de inicializa√ß√£o
‚îú‚îÄ‚îÄ public/                # Frontend est√°tico
‚îÇ   ‚îú‚îÄ‚îÄ js/               # JavaScript do frontend
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js       # Autentica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login.js      # Login
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ register.js   # Registro
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard.js  # Dashboard
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.js      # Lista de usu√°rios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user-profile.js # Perfil
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ forgot-password.js # Recupera√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ styles.css        # Estilos
‚îÇ   ‚îú‚îÄ‚îÄ index.html        # P√°gina inicial
‚îÇ   ‚îú‚îÄ‚îÄ login.html
‚îÇ   ‚îú‚îÄ‚îÄ register.html
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.html
‚îÇ   ‚îú‚îÄ‚îÄ users.html
‚îÇ   ‚îú‚îÄ‚îÄ user.html
‚îÇ   ‚îî‚îÄ‚îÄ forgot-password.html
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ models/           # Modelos Sequelize
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ User.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Comment.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js
‚îÇ   ‚îú‚îÄ‚îÄ routes/           # Rotas da API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js       # Autentica√ß√£o
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ users.js      # Usu√°rios
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.js      # Utilit√°rios
‚îÇ   ‚îú‚îÄ‚îÄ utils/            # Utilit√°rios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.js       # JWT e middleware
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db.js         # Conex√£o Sequelize
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ asyncHandler.js # Error handling
‚îÇ   ‚îî‚îÄ‚îÄ server.js         # Servidor Express
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ README.md
```

## üé® Design System

Paleta de cores:
- Deep Forest: `#064E3B`
- Emerald: `#059669`
- Jade: `#10B981`
- Mint: `#6EE7B7`
- Lime: `#84CC16`

Componentes dispon√≠veis:
- Bot√µes (`.btn`, `.btn-primary`, `.btn-secondary`)
- Cards (`.card`)
- Forms (`.form-group`, `.form-container`)
- Navega√ß√£o (`.navbar`)
- Mensagens (`.message`, `.error`)

## üîí Recursos de Seguran√ßa (Paradoxalmente)

Mesmo sendo intencionalmente vulner√°vel, o projeto implementa:
- ‚úÖ Sequelize ORM (previne SQL Injection)
- ‚úÖ Sistema de tratamento de erros robusto
- ‚úÖ Shutdown gracioso do servidor
- ‚úÖ Logs detalhados de erros
- ‚úÖ CORS configurado

## üìö Documenta√ß√£o Adicional

- `API_README.md` - Documenta√ß√£o detalhada da API
- `ERROR_HANDLING.md` - Sistema de tratamento de erros
- `CHANGELOG.md` - Hist√≥rico de mudan√ßas

## üõ†Ô∏è Tecnologias

- **Backend**: Express.js, Sequelize, JWT, CORS
- **Frontend**: Vanilla JavaScript, HTML5, CSS3
- **Database**: MySQL 8
- **Tools**: Docker, Docker Compose, Adminer

## üìù Observa√ß√µes Did√°ticas

- Cookies sem `httpOnly` permitem acesso via JavaScript
- JWT decodificado no client sem valida√ß√£o
- XSS por falta de sanitiza√ß√£o de inputs
- IDOR por falta de valida√ß√£o de ownership
- Mass assignment sem whitelist de campos
- SSRF sem valida√ß√£o de destino
- OTP armazenado em cookie n√£o-seguro
- Senhas em texto plano (sem hash)

## ‚öñÔ∏è Licen√ßa

MIT - Use com responsabilidade e apenas em ambientes de teste/aprendizado.

---

**Desenvolvido para fins educacionais de Ciberseguran√ßa** üéìüîê
